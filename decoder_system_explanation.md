# TCP解码器系统实现说明

## 已删除内容说明

### 1. DecoderType枚举
**删除原因**：
- 原有`DecoderType`枚举仅支持简单的类型区分，无法传递配置参数
- 改用更灵活的`DecoderConfig`枚举，支持为每种解码器提供具体配置
- 与`tokio_util::codec`库更好地集成，支持其提供的各种编解码器

### 2. 旧自定义解码器实现
**删除原因**：
- 替换为Tokio官方提供的`tokio_util::codec`库，包含成熟的编解码器实现
- 利用库的缓冲逻辑，避免手动处理复杂的缓冲区管理
- 支持多种预设编解码器：`LinesCodec`（换行符分隔）、`LengthDelimitedCodec`（长度前缀）等

## 配置文件处理

### 向后兼容性
- 新增的`decoder_config`字段使用`#[serde(default)]`注解
- 老配置文件中无该字段时，会自动使用默认值（5ms超时解码器）
- 配置读取不会报错，确保平滑升级

### 配置文件结构
```rust
#[derive(Debug, Clone, Serialize, Deserialize, PartialEq)]
pub struct ClientConfig {
    // 其他字段...
    #[serde(default)]
    pub decoder_config: DecoderConfig,
}
```

## 新建TCP时的解码器选择

### 需求
- **UI集成**：在连接建立前，允许用户选择解码器类型
- **默认值**：默认为5ms超时解码器
- **修改时机**：仅在断开连接时可修改解码器配置
- **显示**：在tab页连接信息中显示当前选择的解码器

### 实现方案
1. **UI组件**：在`connection_tab.rs`中添加解码器选择控件
2. **状态管理**：确保只有在断开状态下才能修改解码器
3. **配置传递**：连接建立时将所选解码器配置传递给TCP处理逻辑
4. **显示更新**：在连接信息区域实时显示当前解码器

## 解码器类型说明

### 1. 超时解码器（默认）
- 基于固定时间间隔（5ms）分割消息
- 适用于无法预知消息边界的场景
- 实现：使用自定义超时逻辑包装`BytesCodec`

### 2. 换行符分隔解码器
- 按`\n`或`\r\n`分割消息
- 实现：`tokio_util::codec::LinesCodec`

### 3. 长度前缀解码器
- 消息前带有固定长度的前缀，指示消息体长度
- 实现：`tokio_util::codec::LengthDelimitedCodec`

### 4. JSON解码器
- 尝试将接收到的数据解析为JSON格式
- 实现：基于`tokio-serde-json`库

## 编解码器使用流程

1. **配置选择**：用户在UI中选择解码器类型和参数
2. **配置保存**：将解码器配置保存到连接配置中
3. **编解码器创建**：连接建立时，根据配置创建对应的编解码器
4. **消息处理**：使用`Framed`流处理TCP连接，自动进行消息分割
5. **消息传递**：将完整消息传递给上层处理逻辑

## 技术优势

1. **成熟可靠**：基于Tokio官方库，经过广泛测试
2. **灵活扩展**：易于添加新的解码器类型
3. **性能优化**：库内部实现了高效的缓冲管理
4. **代码简化**：减少了自定义缓冲处理的复杂性
5. **向后兼容**：确保老配置文件能正常使用

## 后续改进方向

1. **UI优化**：增强解码器选择界面，提供更直观的配置选项
2. **性能测试**：对比不同解码器在高负载下的表现
3. **更多解码器**：根据需求添加其他类型的解码器
4. **动态切换**：探索在连接状态下动态切换解码器的可能性
